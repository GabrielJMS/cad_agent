# CAD Agent - Tasks Configuration (Delegation-Based Workflow)
# The Build123D Orchestrator is the main driver that delegates to specialists

extract_design_intent_task:
  description: >
    STEP 1: REFORMULATE & ENHANCE THE USER PROMPT
    
    Given user input: '{user_input}'
    
    Your job is to transform this (potentially vague) input into a detailed technical specification.
    
    PROCESS:
    1. **Analyze the prompt**: Identify what's clear vs. what's missing
    2. **Ask clarifying questions** (if user interaction available) OR make intelligent assumptions
    3. **Reformulate the requirements** in precise engineering terms
    4. **Extract design intent**: What is the real goal? (e.g., "lightweight" → thin walls, weight target)
    5. **Identify standard parts**: Map informal names to standards (e.g., "bolt" → ISO 4762 M6x20)
    6. **Specify missing details** using engineering best practices
    
    EXTRACT & STRUCTURE:
    - Component list: geometry type (cylinder, box, custom profile), dimensions with units
    - Features: fillets (specify radius), chamfers, holes (diameter, depth, pattern), threads (designation)
    - Standard parts: proper designations (ISO/DIN/ANSI numbers, sizes, grades)
    - Materials: specific grades (e.g., "steel" → "AISI 304 stainless steel")
    - Tolerances: general or specific (e.g., "tight fit" → H7/g6)
    - Constraints: clearances (specify mm), alignments, assembly order, orientation
    - Design intent: weight target, strength requirements, manufacturing method, cost constraints
    
    MAKE INTELLIGENT ASSUMPTIONS:
    - If "small bracket" → assume 50-100mm range, 3-5mm wall thickness
    - If "bolt holes" → assume standard clearance (M6 → 6.6mm hole)
    - If "rounded edges" → assume 2-3mm fillet radius
    - If "mounting plate" → assume flat surface, standard hole pattern
    
    ALWAYS NOTE:
    - What assumptions you made and why
    - What information would improve the design (for user to provide)
    - Alternative interpretations if prompt is ambiguous
    
    Output a rich, detailed specification ready for CAD generation.
  expected_output: >
    A comprehensive structured specification containing:
    - original_prompt: string (as entered by user)
    - reformulated_requirements: string (clear, enhanced version)
    - design_intent: object (primary goals, constraints, priorities)
    - assumptions_made: array of strings (what you assumed and why)
    - design_name: string
    - description: string (detailed technical description)
    - components: array of component objects with:
        * name, geometry_type, dimensions (with units), features, material
    - standard_parts: array with proper designations and specifications
    - constraints: array of design constraints with specifics
    - materials: object with specific grades and properties
    - tolerances: object with tolerance specifications
    - manufacturing_notes: array of relevant manufacturing considerations
    - clarifications_needed: array of questions (if critical info missing)
  agent: design_intent_agent

orchestrate_cad_generation_task:
  description: >
    You are the Lead CAD Programmer coordinating the entire Build123D code generation.
    You have the strongest knowledge of Build123D and access to the full codebase.
    
    YOUR WORKFLOW:
    
    1. ANALYZE the design specification from the previous task
    
    2. CREATE A PLAN using pseudocode/comments to structure the code:
       
       IMPORTANT: The pseudocode example below is just a REFERENCE and GUIDE - NOT a rigid
       template you must follow exactly. Adapt the structure, steps, and organization based
       on the actual design requirements. You have full flexibility to:
       - Add, remove, or reorder steps as needed
       - Use different approaches for different designs
       - Organize the code in whatever way makes most sense
       - Adjust the level of detail based on complexity
       
       Example pseudocode structure (ADAPT AS NEEDED):
       ```python
       # Main CAD Model: [design_name]
       # Imports: [list what's needed]
       
       # Step 1: Define parameters
       # [list all dimensions and parameters]
       
       # Step 2: Create base sketch
       # [describe sketch approach]
       
       # Step 3: 3D operations
       # [describe extrude/revolve/etc]
       
       # Step 4: Add features
       # [describe fillets, chamfers, holes]
       
       # Step 5: Standard parts (if any)
       # [list standard parts to add]
       
       # Step 6: Export
       # [STEP and STL export]
       ```
    
    3. FOR EACH CODE SECTION, DECIDE:
       - If it's SIMPLE → Write it yourself (you're the Build123D expert!)
       - If it's COMPLEX → Delegate to a specialist:
         * Sketch Expert: For complex 2D profiles with many constraints
         * Operations Expert: For complex 3D operations (loft, sweep, booleans)
         * Selector Expert: For tricky geometry selection and filtering
         * Feature Expert: For complex patterns or multiple features
         * Calculation Expert: For engineering calculations or parametric relationships
    
    4. INTEGRATE all code sections into a cohesive, production-ready script with:
       - Proper imports
       - Clear variable names
       - Comprehensive comments
       - STEP and STL export
    
    5. DELEGATE TO SPECIALISTS by asking them specific questions like:
       - "Sketch Expert: Generate a BuildSketch for [specific geometry description]"
       - "Operations Expert: Create code to [specific 3D operation]"
       - "Selector Expert: Write selector code to find [specific geometry]"
    
    Remember: You can write most code yourself. Only delegate when complexity requires
    specialized expertise.
  expected_output: >
    A complete, production-ready Build123D Python script that:
    - Has a clear pseudocode plan at the top (commented)
    - Includes all necessary imports
    - Defines all parameters
    - Creates all components in proper order
    - Applies all features and operations
    - Includes standard parts if specified
    - Has clear comments throughout
    - Exports to STEP and STL files
    - Is tested and verified to work
    
    Save the final script to: outputs/generated_code/cad_model.py
  agent: build123d_orchestrator
  context:
    - extract_design_intent_task
  output_file: outputs/generated_code/cad_model.py

validate_code_and_geometry_task:
  description: >
    Execute the Build123D script generated by the orchestrator, validate the geometry,
    verify dimensions, and test export to STEP/STL formats.
    
    Validation steps:
    1. Read and execute the complete Python script from outputs/generated_code/cad_model.py
    2. Capture any errors or exceptions with detailed traceback
    3. Validate the resulting geometry:
       - Check that it's a valid manifold solid
       - Verify volume is positive and reasonable
       - Check bounding box dimensions match specification
    4. Verify critical dimensions match the specification (within tolerance)
    5. Test export to STEP format (outputs/cad_files/step/)
    6. Test export to STL format (outputs/cad_files/stl/)
    7. Verify exported files exist and have reasonable sizes
    
    If errors occur, provide specific feedback:
    - Error type and message
    - Line number if applicable
    - Suggested fix
    - Whether to ask orchestrator to regenerate code
    
    If validation passes, provide confirmation with file paths and geometry stats.
  expected_output: >
    A comprehensive validation report containing:
    - execution_success: boolean
    - errors: array of error details (if any)
    - geometry_valid: boolean
    - manifold_check: boolean
    - volume: number (in cubic mm or appropriate units)
    - bounding_box: {min: [x,y,z], max: [x,y,z], dimensions: [w,h,d]}
    - dimensions_accurate: boolean
    - dimension_errors: array (if any discrepancies found)
    - step_file_path: string (if successful)
    - stl_file_path: string (if successful)
    - export_success: boolean
    - validation_timestamp: ISO string
    - next_steps: string (recommendations)
    
    Save report to: outputs/validation_reports/validation_report.json
  agent: validation_agent
  context:
    - extract_design_intent_task
    - orchestrate_cad_generation_task
  output_file: outputs/validation_reports/validation_report.json

